# 功能規格書：CRM 認證 API 整合

**功能分支**：`002-crm-api-integration`
**建立日期**：2025-10-23
**狀態**：草稿
**輸入**：使用者描述："docs\openapi.yaml有crm的api說明,需要完成登入功能的串接,如果這是一份sass的登入入口專案,會怎麼建議處理這個部分"

## 澄清

### Session 2025-10-23

- Q: 對於處理認證權杖的 SaaS 入口，應使用哪種儲存策略？ → A: 更新權杖使用 HttpOnly cookies + 存取權杖使用記憶體/sessionStorage（對 XSS 具最佳安全性，需要後端 cookie 支援）
- Q: 系統應該在權杖過期前多久自動更新存取權杖？ → A: 權杖剩餘時間少於 5 分鐘時（平衡安全性和效能的標準做法）
- Q: 當認證 API 呼叫失敗（網路錯誤、5xx 錯誤）時，系統應該如何處理？ → A: 有限重試（最多 3 次）+ 指數退避（1 秒、2 秒、4 秒），僅對暫時性錯誤重試，客戶端錯誤（4xx）不重試
- Q: 「記住我」功能應如何影響權杖的儲存和過期策略？ → A: 延長更新權杖有效期至 30 天（而非預設較短期限），存取權杖維持 1 小時；HttpOnly cookie 設定為持久性 cookie 而非會話 cookie
- Q: 認證流程應該記錄哪些事件以支援營運和安全需求？ → A: 記錄關鍵認證事件（登入成功/失敗、登出、權杖更新、API 錯誤），包含使用者 ID、時間戳記、錯誤類型，但絕不記錄敏感資料（密碼、完整權杖內容）

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 基本登入認證（優先級：P1）

使用者需要使用帳號和密碼憑證安全地登入 SaaS 平台。成功登入後，使用者獲得系統存取權限，可以進入個人化儀表板。

**為何此優先級**：這是所有其他功能所需的基礎認證能力。沒有可運作的登入功能，使用者無法存取任何系統功能。

**獨立測試**：可透過在登入頁面輸入有效憑證並驗證使用者被重定向至儀表板且具有有效會話來完整測試。立即提供價值，實現對平台的安全存取。

**驗收場景**：

1. **假設** 使用者擁有有效憑證，**當** 他們輸入帳號和密碼並提交登入表單，**則** 他們收到存取權杖、通過認證，並被重定向至儀表板
2. **假設** 使用者輸入無效憑證，**當** 他們提交登入表單，**則** 他們看到清楚的錯誤訊息指出認證失敗，並留在登入頁面
3. **假設** 使用者成功登入且啟用「記住我」，**當** 他們關閉並重新開啟瀏覽器，**則** 他們的會話持續存在且保持登入狀態
4. **假設** 使用者的存取權杖已過期，**當** 他們嘗試存取受保護資源，**則** 系統自動嘗試使用儲存的更新權杖來更新他們的權杖

---

### 使用者故事 2 - 權杖生命週期管理（優先級：P2）

使用者需要其認證會話被安全且有效地管理，包括自動更新權杖以防止活躍會話期間的中斷，以及登出時的適當清理。

**為何此優先級**：透過防止活躍使用期間的意外登出來增強使用者體驗，同時透過權杖過期和適當的會話管理來維持安全性。

**獨立測試**：可透過在延長會話期間監控權杖更新行為，以及驗證登出時權杖被正確失效來測試。透過改善使用者體驗和安全性來提供價值。

**驗收場景**：

1. **假設** 使用者的存取權杖即將過期（5 分鐘內），**當** 他們發出任何經認證的請求，**則** 系統在背景自動更新他們的權杖而無需重新登入
2. **假設** 使用者的更新權杖無效或已過期，**當** 系統嘗試更新，**則** 使用者被登出並重定向至登入頁面
3. **假設** 已登入的使用者點擊登出按鈕，**當** 登出被處理，**則** 他們的權杖在伺服器上被失效、從客戶端儲存中移除，並被重定向至登入頁面
4. **假設** 使用者在登出後嘗試使用已失效的權杖，**當** 他們發出經認證的請求，**則** 請求被拒絕且他們被重定向至登入

---

### 使用者故事 3 - 使用者檔案與會話資訊（優先級：P3）

使用者需要查看其個人資料訊息並了解其當前認證狀態，包括角色、權限和帳戶詳細資訊。

**為何此優先級**：提供關於認證狀態的透明度並幫助使用者了解其帳戶情境，但對基本認證流程並非關鍵。

**獨立測試**：可透過在登入後擷取並顯示當前使用者資訊來測試。透過幫助使用者了解其帳戶狀態和權限來提供價值。

**驗收場景**：

1. **假設** 使用者已登入，**當** 他們存取個人資料頁面，**則** 他們看到其帳號、電子郵件、全名、部門、地區和最後登入時間
2. **假設** 使用者已登入，**當** 應用程式初始化，**則** 他們的當前使用者資訊被擷取並儲存以供整個應用程式使用
3. **假設** 使用者的會話資訊已變更（例如角色更新），**當** 他們重新整理應用程式，**則** 他們更新的資訊被擷取並反映在 UI 中

---

### 邊界案例

- 當 CRM API 伺服器無法連線或在登入期間返回 5xx 錯誤時：系統自動重試最多 3 次（使用指數退避），全部失敗後顯示錯誤訊息
- 當使用者的帳戶在登入嘗試之間變為非活躍或被停用時：API 返回 401 錯誤，系統顯示帳戶狀態錯誤訊息
- 系統如何處理權杖更新期間的網路中斷：自動重試最多 3 次，失敗後登出使用者並重定向至登入頁面
- 當更新權杖在使用者積極使用應用程式時過期會發生什麼：更新請求失敗，使用者被登出並重定向至登入頁面
- 系統如何處理同一使用者在不同裝置上的並行登入嘗試：每次登入產生獨立的權杖集，由 CRM API 後端管理會話策略
- 當 API 回應格式錯誤或缺少預期欄位時：驗證失敗，記錄錯誤，顯示通用錯誤訊息給使用者
- 系統如何處理來自 CRM API 的速率限制或節流（429 錯誤）：視為暫時性錯誤，進行重試，若持續失敗則通知使用者稍後再試
- 當權杖在客戶端儲存中被竄改或損壞時：API 返回 401 錯誤，系統清除無效權杖並重定向至登入頁面

## 需求 *(必填)*

### 功能性需求

- **FR-001**：系統必須使用帳號和密碼憑證對 CRM API 的 `/api/v1/auth/login` 端點進行使用者認證
- **FR-002**：系統必須安全地儲存從認證 API 收到的權杖：更新權杖必須儲存在 HttpOnly cookies 中以防止 XSS 攻擊，存取權杖可儲存在記憶體或 sessionStorage 中供當前會話使用
- **FR-003**：系統必須使用 Bearer 認證方案在所有經認證的 API 請求中包含存取權杖
- **FR-004**：系統必須在存取權杖剩餘有效時間少於 5 分鐘時，使用 `/api/v1/auth/refresh` 端點和儲存的更新權杖自動更新存取權杖
- **FR-005**：系統必須透過清除儲存的權杖並將使用者重定向至登入頁面來處理權杖更新失敗
- **FR-006**：系統必須允許使用者透過 `/api/v1/auth/logout` 端點自願登出，該端點會在伺服器上使其權杖失效
- **FR-007**：系統必須在登出時從客戶端儲存中移除所有儲存的認證權杖
- **FR-008**：系統必須擷取並儲存從成功登入返回的使用者資訊（id、username、email、full_name、department、region、is_active、last_login_at）
- **FR-009**：系統必須允許使用者透過 `/api/v1/auth/me` 端點擷取其當前認證狀態和檔案
- **FR-010**：系統必須在處理前驗證來自 CRM API 的回應符合預期架構
- **FR-011**：系統必須優雅地處理 API 錯誤：對於暫時性錯誤（網路問題、5xx 錯誤）自動重試最多 3 次，使用指數退避（1 秒、2 秒、4 秒）；對於客戶端錯誤（4xx，除了 401）不重試，直接顯示使用者友善的錯誤訊息
- **FR-012**：系統必須支援「記住我」功能：當使用者勾選「記住我」時，要求 CRM API 發放有效期為 30 天的更新權杖，並將 HttpOnly cookie 設定為持久性 cookie（有明確過期時間）；未勾選時使用會話 cookie 和較短期限的更新權杖
- **FR-013**：系統必須提供可供所有應用程式元件存取的集中式認證狀態管理
- **FR-014**：系統必須保護需要認證的路由和元件，將未認證的使用者重定向至登入頁面
- **FR-015**：系統必須在發出經認證請求前透過嘗試自動更新來處理權杖過期
- **FR-016**：系統必須在跨不同來源與 CRM API 通訊時處理 CORS 需求
- **FR-017**：系統必須透過配置支援多個 CRM API 環境（開發、預備、生產）
- **FR-018**：系統必須記錄關鍵認證事件以支援營運和安全稽核：記錄登入成功/失敗、登出、權杖更新、API 錯誤，包含使用者 ID、時間戳記、錯誤類型；絕不記錄敏感資料（密碼、完整權杖內容、個人識別資訊）

### 關鍵實體

- **使用者**：代表經認證的使用者，具有包括使用者 ID、帳號、電子郵件、全名、部門、地區、活躍狀態和最後登入時間戳記的屬性
- **認證權杖**：代表用於認證 API 請求的 JWT 存取權杖，包括過期時間和權杖類型
- **更新權杖**：代表用於取得新存取權杖而無需重新認證的權杖
- **認證會話**：代表當前使用者的認證狀態，包括權杖、使用者資訊和會話中繼資料

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**：使用者在穩定網路連線下使用有效憑證可在 5 秒內完成登入流程並到達儀表板
- **SC-002**：系統在無使用者介入的情況下成功自動更新權杖，維持至少 8 小時活躍使用的不中斷會話
- **SC-003**：在正常作業條件下（不包括無效憑證或過期權杖），99% 的認證 API 呼叫成功
- **SC-004**：使用者在失敗後 2 秒內收到所有認證失敗場景的清楚、可操作錯誤訊息
- **SC-005**：認證狀態在所有應用程式頁面和元件中一致可用，無需冗餘的 API 呼叫
- **SC-006**：登出流程在 2 秒內完成並清除所有認證資料
- **SC-007**：登入系統成功處理至少 100 個並行登入嘗試而無效能降級
- **SC-008**：「記住我」功能維持使用者會話至少 30 天而無需重新登入
- **SC-009**：認證整合在所有三個配置環境（開發、預備、生產）中正確運作且無需程式碼變更

## 假設

- CRM API 可從 SaaS 前端應用程式的網域存取，或已有適當的 CORS 配置
- CRM API 使用 JWT（JSON Web Token）格式的存取權杖
- 存取權杖有標準過期時間（根據 API 回應推測為 3600 秒 / 1 小時）
- CRM API 環境 URL 和端點遵循 OpenAPI 規格中定義的結構
- 使用者憑證（帳號/密碼）已在 CRM 系統中配置
- 瀏覽器環境支援 HttpOnly cookies 和 sessionStorage 以安全地儲存權杖
- 前端應用程式有對應的後端服務支援 HttpOnly cookie 的設定和管理
- 網路連線通常穩定，儘管系統應優雅地處理暫時性中斷

## 相依性

- CRM API 必須部署且可在配置的伺服器 URL 存取
- CRM API 認證端點必須可運作並根據 OpenAPI 規格回應
- 前端應用程式必須具有對 CRM API 伺服器的網路存取
- 使用者必須在 CRM 系統中擁有有效的已配置帳戶

## 範圍邊界

**範圍內：**
- 與 CRM 認證端點（login、logout、refresh、me）的整合
- 客戶端權杖儲存和管理
- 自動權杖更新邏輯
- 認證狀態管理
- 受保護路由處理
- 認證失敗的錯誤處理
- 「記住我」會話持久化

**範圍外：**
- 使用者註冊或帳戶建立（CRM API 未提供）
- 密碼重設功能（CRM API 端點未提供）
- 多因素認證（CRM API 未指定）
- 基本認證之外的角色基礎存取控制（CRM 中存在 RBAC 功能但與登入整合分開）
- 權限檢查和授權邏輯（與認證分開）
- 使用者檔案編輯（來自 CRM 的使用者資訊為唯讀）
- 社交登入或第三方認證提供者
- 跨多個裝置的會話管理（由 CRM API 後端處理）
